#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This has to be exported to make some magic below work.
export DH_OPTIONS

configure: configure-stamp
configure-stamp:
	dh_testdir
	touch configure-stamp

build: configure-stamp

install: configure-stamp
	dh_testdir
	dh_testroot
	dh_installdirs

	# Config files (-apache)
	cp $(CURDIR)/debian/config.php $(CURDIR)/debian/mahara-apache/etc/mahara/
	cp $(CURDIR)/debian/apache.conf.template $(CURDIR)/debian/mahara-apache/etc/mahara/apache.conf
	perl -i -p -e "s|__APACHELOGDIR__|/var/log/apache|" $(CURDIR)/debian/mahara-apache/etc/mahara/apache.conf

	# Config files (-apache2)
	cp $(CURDIR)/debian/config.php $(CURDIR)/debian/mahara-apache2/etc/mahara/
	cp $(CURDIR)/debian/apache.conf.template $(CURDIR)/debian/mahara-apache2/etc/mahara/apache.conf
	perl -i -p -e "s|__APACHELOGDIR__|/var/log/apache2|" $(CURDIR)/debian/mahara-apache2/etc/mahara/apache.conf

clean:
	dh_testdir
	dh_testroot
	rm -f configure-stamp
	dh_clean 
	debconf-updatepo

binary: build install
	dh_testdir
	dh_testroot
	dh_installchangelogs 
	dh_installdocs
	dh_installdebconf
	dh_installcron
	dh_installlogrotate
	dh_compress 
	dh_fixperms

	cat $(CURDIR)/debian/commonfunctions.sh >> $(CURDIR)/debian/mahara-apache2.postinst.debhelper
	cat $(CURDIR)/debian/commonfunctions.sh >> $(CURDIR)/debian/mahara-apache2.postrm.debhelper
	cat $(CURDIR)/debian/commonfunctions.sh >> $(CURDIR)/debian/mahara-apache.postinst.debhelper
	cat $(CURDIR)/debian/commonfunctions.sh >> $(CURDIR)/debian/mahara-apache.postrm.debhelper
	dh_installdeb

	dh_install

	dh_link

	dh_gencontrol
	dh_md5sums

	dh_builddeb

.PHONY: build clean binary install configure
